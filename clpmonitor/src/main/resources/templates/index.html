<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Monitoramento de CLPs</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" th:href="@{/css/store.css}">
    <link rel="stylesheet" th:href="@{/css/index.css}">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Bancada 4.0</h2>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li>
                    <a href="/" class="active">
                        <span class="material-symbols-rounded">description</span>
                        <span>Edição</span>
                    </a>
                </li>
                <li>
                    <a href="/store">
                        <span class="material-symbols-rounded">home</span>
                        <span>Pedido</span>
                    </a>
                </li>
                <li>
                    <a href="history.html">
                        <span class="material-symbols-rounded">history</span>
                        <span>Histórico</span>
                    </a>
                </li>
                <li>
                    <a href="status.html">
                        <span class="material-symbols-rounded">monitoring</span>
                        <span>Status</span>
                    </a>
                </li>
                <li>
                    <a href="settings.html">
                        <span class="material-symbols-rounded">settings</span>
                        <span>Configurações</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Conteúdo Principal -->
    <div class="main-container">
        <div class="container">
            <header class="header">
                <h1>Gerenciamento</h1>
            </header>

            <main class="main-content">
                <div class="form-section">
                    <h2>Leitura dos dados da Bancada Smart 4.0</h2>

                    <h3>Estoque (CLP 1 - Matriz de 28 bytes)</h3>
                    <div id="clp1-grid" class="grid"></div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="updateStock()">Atualizar Estoque</button>
                        <button class="btn btn-primary" onclick="enableEditMode()">Editar Estoque</button>
                        <button id="saveBtn" class="btn btn-primary" style="display:none;" onclick="saveStock()">Salvar
                            Alterações</button>
                        <button id="cancelBtn" class="btn btn-secondary" style="display:none;"
                            onclick="cancelEdit()">Cancelar</button>
                    </div>

                    <!-- Modal para seleção de cor -->
                    <div id="colorModal" class="modal">
                        <div class="modal-content">
                            <h3>Selecione a Cor</h3>
                            <div class="color-options">
                                <button class="btn btn-primary" onclick="selectColor(0)">Vazio</button>
                                <button class="btn btn-primary" onclick="selectColor(1)">Preto</button>
                                <button class="btn btn-primary" onclick="selectColor(2)">Vermelho</button>
                                <button class="btn btn-primary" onclick="selectColor(3)">Azul</button>
                            </div>
                            <button class="btn btn-secondary" onclick="closeModal()">Fechar</button>
                        </div>
                    </div>

                    <h3>Expedição (CLP 4 - Matriz de 12 bytes)</h3>
                    <div id="expedition-grid" class="grid expedition-grid"></div>
                    <button class="btn btn-primary" onclick="updateExpedition()">Atualizar Expedição</button>
                </div>

            </main>
        </div>
    </div>

    <script>
        let currentEditPosition = null;
        const stockData = Array(28).fill(0);
        const originalStockData = [...stockData];

        // Função para carregar dados iniciais do estoque
        async function loadInitialStockData() {
            try {
                const response = await fetch('/estoque/listar');
                if (!response.ok) throw new Error('Erro ao carregar estoque');

                const data = await response.json();
                data.forEach((val, i) => {
                    if (i < stockData.length) {
                        stockData[i] = val;
                        originalStockData[i] = val;
                    }
                });

                updateStockGrid();
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                alert('Erro ao carregar estoque: ' + error.message);
            }
        }

        // Event Source para atualizações em tempo real
        const eventSource = new EventSource('/clp-data-stream');

        eventSource.addEventListener('clp1-data', function (event) {
            try {
                const data = JSON.parse(event.data);
                const colors = data.value || data; // Suporta ambos formatos

                colors.forEach((val, i) => {
                    if (i < stockData.length) {
                        stockData[i] = val;
                        originalStockData[i] = val;
                    }
                });

                updateStockGrid();
            } catch (error) {
                console.error('Erro ao processar atualização:', error);
            }
        });

        eventSource.addEventListener('expedition-data', function (event) {
            try {
                const data = JSON.parse(event.data);
                const expeditionArray = data.value || data;
                const grid = document.getElementById('expedition-grid');
                grid.innerHTML = '';

                expeditionArray.forEach((val, i) => {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.innerHTML = `P${i + 1} = [OP ${val}]`;

                    cell.style.backgroundColor = val
                        ? "rgba(255, 0, 0, 0.3)"
                        : "rgba(0, 255, 0, 0.3)";
                    cell.style.border = val
                        ? "1px solid red"
                        : "1px solid green";

                    grid.appendChild(cell);
                });
            } catch (error) {
                console.error('Erro ao atualizar expedição:', error);
            }
        });

        function updateStockGrid() {
            const grid = document.getElementById('clp1-grid');
            if (!grid) return;

            grid.innerHTML = '';

            stockData.forEach((val, i) => {
                const cell = document.createElement('div');
                cell.classList.add('cell', `color-${val}`);
                cell.textContent = i + 1;

                if (document.getElementById('saveBtn').style.display === 'inline-block') {
                    cell.onclick = () => openColorModal(i);
                }

                grid.appendChild(cell);
            });
        }

        function enableEditMode() {
            toggleEditButtons(true);
        }

        function cancelEdit() {
            stockData.forEach((_, i) => {
                stockData[i] = originalStockData[i];
            });
            updateStockGrid();
            toggleEditButtons(false);
        }

        function toggleEditButtons(show) {
            document.getElementById('saveBtn').style.display = show ? 'inline-block' : 'none';
            document.getElementById('cancelBtn').style.display = show ? 'inline-block' : 'none';
            document.querySelector('button[onclick="enableEditMode()"]').style.display = show ? 'none' : 'inline-block';
        }

        function openColorModal(position) {
            currentEditPosition = position;
            document.getElementById('colorModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('colorModal').style.display = 'none';
        }

        function selectColor(color) {
            if (currentEditPosition !== null) {
                stockData[currentEditPosition] = color;
                updateStockGrid();
                closeModal();
            }
        }

        async function saveStock() {
            try {
                const response = await fetch('/estoque/editar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ listBlocks: stockData })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Erro ao salvar');
                }

                const result = await response.json();
                console.log('Salvo com sucesso:', result);

                // Atualiza os dados originais após salvar
                stockData.forEach((val, i) => {
                    originalStockData[i] = val;
                });

                toggleEditButtons(false);
                alert('Estoque salvo com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar: ' + error.message);
                cancelEdit();
            }
        }

        // Funções auxiliares para CLP
        function update() {
            fetch('/update', { method: 'POST' })
                .catch(error => console.error('Erro ao atualizar:', error));
        }

        function updateStock() {
            fetch('/update-stock', { method: 'POST' })
                .catch(error => console.error('Erro ao atualizar estoque:', error));
        }

        function updateExpedition() {
            fetch('/update-expedition', { method: 'POST' })
                .catch(error => console.error('Erro ao atualizar expedição:', error));
        }

        // Inicialização
        window.onload = function () {
            loadInitialStockData();
            updateExpedition();
            updateStock();
            addMenuButton();
        };

        // Sidebar functions
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        document.addEventListener('click', function (event) {
            const sidebar = document.querySelector('.sidebar');
            const isClickInsideSidebar = sidebar.contains(event.target);
            const isClickOnMenuButton = event.target.closest('.menu-button');

            if (window.innerWidth <= 768 && !isClickInsideSidebar && !isClickOnMenuButton) {
                sidebar.classList.remove('active');
            }
        });

        function addMenuButton() {
            if (window.innerWidth <= 768) {
                const header = document.querySelector('.header');
                if (!document.querySelector('.menu-button')) {
                    const menuButton = document.createElement('button');
                    menuButton.className = 'menu-button btn btn-secondary';
                    menuButton.innerHTML = '<span class="material-symbols-rounded">menu</span>';
                    menuButton.onclick = toggleSidebar;
                    header.insertBefore(menuButton, header.firstChild);
                }
            }
        }

        window.addEventListener('resize', addMenuButton);
    </script>
</body>

</html>